<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do List</title>
    <style>
        /* Basic styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        /* Form */
        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        input[type="text"], textarea {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        button {
            padding: 0.75rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #2980b9;
        }
        /* Filters */
        .filters {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        /* Task List */
        #task-list {
            list-style: none;
            padding: 0;
        }
        .task-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        .task-item:last-child {
            border-bottom: none;
        }
        .task-item.completed .task-content {
            text-decoration: line-through;
            color: #95a5a6;
        }
        .task-item input[type="checkbox"] {
            margin-right: 1rem;
            transform: scale(1.2);
        }
        .task-content {
            flex-grow: 1;
        }
        .task-content strong {
            display: block;
            font-size: 1.1rem;
        }
        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .delete-btn:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>My To-Do List</h1>

        <form id="add-task-form">
            <input type="text" id="title" placeholder="Task Title" required>
            <textarea id="description" placeholder="Task Description"></textarea>
            <button type="submit">Add Task</button>
        </form>

        <div class="filters">
            <label><input type="radio" name="filter" value="all" checked> All</label>
            <label><input type="radio" name="filter" value="completed"> Completed</label>
            <label><input type="radio" name="filter" value="incomplete"> Incomplete</label>
        </div>

        <ul id="task-list">
            </ul>
    </div>

    <script>
        // --- CONFIG ---
        const API_BASE_URL = 'http://localhost:5000/api/tasks';

        // --- STATE ---
        let currentFilter = 'all';

        // --- SELECTORS ---
        const taskList = document.getElementById('task-list');
        const form = document.getElementById('add-task-form');
        const titleInput = document.getElementById('title');
        const descriptionInput = document.getElementById('description');
        const filterRadios = document.querySelectorAll('input[name="filter"]');

        // --- API FUNCTIONS ---

        /**
         * Fetches tasks from the API based on the current filter
         */
        async function fetchTasks() {
            let url = API_BASE_URL;
            if (currentFilter === 'completed') {
                url += '?completed=true';
            } else if (currentFilter === 'incomplete') {
                url += '?completed=false';
            }

            try {
                const response = await fetch(url);
                const tasks = await response.json();
                renderTasks(tasks);
            } catch (error) {
                console.error('Failed to fetch tasks:', error);
                taskList.innerHTML = '<li>Error loading tasks. Is the server running?</li>';
            }
        }

        /**
         * Creates a new task
         */
        async function createTask(e) {
            e.preventDefault(); // Stop form from reloading page
            const title = titleInput.value;
            const description = descriptionInput.value;

            if (!title) return; // Title is required

            try {
                await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description }),
                });
                
                // Clear form and refresh list
                titleInput.value = '';
                descriptionInput.value = '';
                fetchTasks(); 
            } catch (error) {
                console.error('Failed to create task:', error);
            }
        }

        /**
         * Updates a task's completion status
         */
        async function updateTaskStatus(id, completed) {
            try {
                await fetch(`${API_BASE_URL}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed }),
                });
                
                // Refresh list to reflect changes and filtering
                fetchTasks();
            } catch (error) {
                console.error('Failed to update task:', error);
            }
        }

        /**
         * Deletes a task
         */
        async function deleteTask(id) {
            try {
                await fetch(`${API_BASE_URL}/${id}`, {
                    method: 'DELETE',
                });
                
                // Refresh list
                fetchTasks();
            } catch (error) {
                console.error('Failed to delete task:', error);
            }
        }

        // --- RENDER FUNCTION ---

        /**
         * Clears and re-renders the task list in the DOM
         */
        function renderTasks(tasks) {
            taskList.innerHTML = ''; // Clear existing tasks
            
            if (tasks.length === 0) {
                taskList.innerHTML = '<li>No tasks found.</li>';
                return;
            }

            tasks.forEach(task => {
                const li = document.createElement('li');
                li.className = 'task-item';
                li.dataset.id = task.id; // Store ID on the element
                if (task.completed) {
                    li.classList.add('completed');
                }

                li.innerHTML = `
                    <input type="checkbox" ${task.completed ? 'checked' : ''}>
                    <div class="task-content">
                        <strong>${escapeHTML(task.title)}</strong>
                        <p>${escapeHTML(task.description)}</p>
                    </div>
                    <button class="delete-btn">Delete</button>
                `;
                
                taskList.appendChild(li);
            });
        }

        // --- UTILITY ---
        
        /**
         * Simple HTML escaping to prevent XSS
         */
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }


        // --- EVENT LISTENERS ---

        /**
         * Handles clicks on the task list (for update/delete)
         */
        function handleListClick(e) {
            const id = e.target.closest('.task-item')?.dataset.id;
            if (!id) return; // Click wasn't on a task

            if (e.target.type === 'checkbox') {
                updateTaskStatus(id, e.target.checked);
            }

            if (e.target.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to delete this task?')) {
                    deleteTask(id);
                }
            }
        }

        /**
         * Handles filter changes
         */
        function handleFilterChange(e) {
            currentFilter = e.target.value;
            fetchTasks();
        }

        // --- INITIALIZATION ---
        
        // Add form submit listener
        form.addEventListener('submit', createTask);
        
        // Add listeners for delete/update
        taskList.addEventListener('click', handleListClick);

        // Add listeners for filter radios
        filterRadios.forEach(radio => {
            radio.addEventListener('change', handleFilterChange);
        });

        // Load initial tasks when the page loads
        document.addEventListener('DOMContentLoaded', fetchTasks);

    </script>
</body>
</html>